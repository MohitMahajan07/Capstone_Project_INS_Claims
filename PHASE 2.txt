----------------------------------------------------------- TASK 5 -----------------------------------------------------------
-- STAR SCHEMA --
CREATE OR REPLACE SCHEMA STAR_DATA;

-- TABLE 1 --
CREATE OR REPLACE TABLE DIMCUSTOMER
AS
SELECT CUSTOMER_ID, CUSTOMER_NAME, REGION_ID, RISKBAND, PHONE, EMAIL
FROM RAW_DATA.CUSTOMER_PROFILE;

ALTER TABLE DimCustomer
ADD CONSTRAINT PK_DimCustomer PRIMARY KEY (CUSTOMER_ID);

SELECT * FROM DIMCUSTOMER;

-- TABLE 2 --
CREATE OR REPLACE TABLE DIMPOLICY
AS 
SELECT POLICY_ID, PRODUCT_TYPE, TENUREMONTHS, SUMASSURED
FROM RAW_DATA.POLICY_MASTER;

ALTER TABLE DIMPOLICY
ADD CONSTRAINT PK_DimPOLICY PRIMARY KEY (POLICY_ID);

SELECT * FROM DIMPOLICY;

-- TABLE 3 --
CREATE OR REPLACE TABLE DIMPROVIDER
AS 
SELECT PROVIDER_ID, PROVIDER_NAME, CATEGORY, REGION_ID
FROM RAW_DATA.STG_PROVIDER_NETWORK;

ALTER TABLE DIMPROVIDER
ADD CONSTRAINT PK_DIMPROVIDER PRIMARY KEY (PROVIDER_ID);

SELECT * FROM DIMPROVIDER;

-- TABLE 4 --
CREATE OR REPLACE TABLE DIMREGION
AS 
SELECT REGION_ID, ZONE, COUNTRY, STATE, BRANCH
FROM RAW_DATA.REGION_HIERARCHY;

ALTER TABLE DIMREGION
ADD CONSTRAINT PK_DIMREGION PRIMARY KEY (REGION_ID);

SELECT * FROM DIMREGION;

CREATE OR REPLACE TABLE DIMDATES
AS 
SELECT CT.POLICY_ID, FNOL_DATE, SURVEY_DATE, APPROVAL_DATE, PAYMENT_DATE, STARTDATE, ENDDATE, DETECTIONDATE
FROM RAW_DATA.STG_CLAIM_TRANSACTION CT
JOIN RAW_DATA.POLICY_MASTER PM ON CT.POLICY_ID = PM.POLICY_ID
JOIN RAW_DATA.FRAUD_ALERTS FA ON CT.CLAIM_ID = FA.CLAIMID;

ALTER TABLE DIMDATES
ADD CONSTRAINT FK_DIMDATES
FOREIGN KEY (POLICY_ID) REFERENCES DIMPOLICY (POLICY_ID);

SELECT * FROM DIMDATES;

----------------------------------------------------------- TASK 6 -----------------------------------------------------------
-- TABLE 1 --
CREATE OR REPLACE TABLE FACTCLAIMS 
AS 
SELECT 
    CLAIM_ID,
    POLICY_ID,
    CUSTOMER_ID,
    PROVIDER_ID,
    REGION_ID,
    PRODUCT_TYPE,
    CLAIM_AMOUNT,
    APPROVED_AMOUNT,
    STATUS
FROM RAW_DATA.STG_CLAIM_TRANSACTION;

-- PRIMARY KEY
ALTER TABLE FACTCLAIMS
ADD CONSTRAINT PK_FACTCLAIMS PRIMARY KEY (CLAIM_ID);

-- FOREIGN KEYS
ALTER TABLE FACTCLAIMS
ADD CONSTRAINT FK_Fact_Policy
FOREIGN KEY (POLICY_ID) REFERENCES DimPolicy(POLICY_ID);

ALTER TABLE FACTCLAIMS
ADD CONSTRAINT FK_Fact_Customer
FOREIGN KEY (CUSTOMER_ID) REFERENCES DimCustomer(CUSTOMER_ID);

ALTER TABLE FACTCLAIMS
ADD CONSTRAINT FK_Fact_Provider
FOREIGN KEY (PROVIDER_ID) REFERENCES DimProvider(PROVIDER_ID);

ALTER TABLE FACTCLAIMS
ADD CONSTRAINT FK_Fact_Region
FOREIGN KEY (REGION_ID) REFERENCES DimRegion(REGION_ID);

SELECT * FROM FACTCLAIMS;

-- TABLE 2 --
CREATE OR REPLACE TABLE FACTSETTLEMENTS
AS
SELECT
    CLAIM_ID,
    (APPROVAL_DATE IS NOT NULL) AS SettlementApproval,
    IFF(APPROVAL_DATE IS NOT NULL,
        DATEDIFF('day', FNOL_DATE, APPROVAL_DATE),
        NULL
    ) AS TAT_Days,
    CASE 
    WHEN APPROVED_AMOUNT > CLAIM_AMOUNT 
        THEN APPROVED_AMOUNT - CLAIM_AMOUNT
    ELSE 0
    END AS LeakageIndicator
FROM RAW_DATA.STG_CLAIM_TRANSACTION;

ALTER TABLE FACTSETTLEMENTS
ADD CONSTRAINT FK_Fact_SETTELMENTS
FOREIGN KEY (CLAIM_ID) REFERENCES FACTCLAIMS (CLAIM_ID);

SELECT * FROM FACTSETTLEMENTS;

-- TABLE 3 --
CREATE OR REPLACE TABLE FACTFRAUD
AS
SELECT
    ALERTID,
    CLAIMID,
    (MODELSCORE > 0.5) AS SIU_Flag,
    MODELSCORE,
    INVESTIGATIONSTATUS,
    OUTCOME
FROM RAW_DATA.FRAUD_ALERTS;

-- Primary Key on ALERTID
ALTER TABLE FACTFRAUD
ADD CONSTRAINT PK_FactFraud PRIMARY KEY (ALERTID);

-- Foreign Key
ALTER TABLE FACTFRAUD
ADD CONSTRAINT FK_Fraud_Claim
FOREIGN KEY (CLAIMID) REFERENCES FACTCLAIMS (CLAIM_ID);

SELECT * FROM FACTFRAUD;