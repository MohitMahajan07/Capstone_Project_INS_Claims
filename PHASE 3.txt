----------------------------------------------------------- TASK 8 -----------------------------------------------------------
-- STREAMS --
CREATE OR REPLACE STREAM ST_CLAIM_TRANSACTION ON TABLE RAW_DATA.STG_CLAIM_TRANSACTION;
CREATE OR REPLACE STREAM ST_FRAUD_ALERTS ON TABLE RAW_DATA.FRAUD_ALERTS;

SELECT * FROM RAW_DATA.ST_CLAIM_TRANSACTION;
SELECT * FROM RAW_DATA.ST_FRAUD_ALERTS;
----------------------------------------------------------- TASK 9 -----------------------------------------------------------
-- CREATING A PSEUDO STREAM --
CREATE OR REPLACE TABLE PSEUDO_STREAM
(
    CLAIM_ID NUMBER(15,2),
    POLICY_ID NUMBER(15,2),
    CUSTOMER_ID NUMBER(15,2),
    PROVIDER_ID NUMBER(15,2),
    REGION_ID NUMBER(15,2),
    PRODUCT_TYPE STRING,
    FNOL_DATE DATE,
    SURVEY_DATE DATE,
    APPROVAL_DATE DATE,
    PAYMENT_DATE DATE,
    CLAIM_AMOUNT NUMBER(10,3),
    APPROVED_AMOUNT NUMBER(10,3),
    STATUS STRING,
    METADATA$ACTION STRING,
    METADATA$ISUPDATE STRING
);

-- CREATING A TASK TO COPY INTO MANNUAL STREAM --
CREATE OR REPLACE TASK TASK_1
WAREHOUSE = 'CAPSTONE_PROJECT'
SCHEDULE = '1 HOUR'
AS 
MERGE INTO PSEUDO_STREAM F      
USING RAW_DATA.ST_CLAIM_TRANSACTION S
ON F.CLAIM_ID = S.CLAIM_ID
WHEN NOT MATCHED 
    THEN INSERT (CLAIM_ID, POLICY_ID, CUSTOMER_ID, PROVIDER_ID, REGION_ID, PRODUCT_TYPE, CLAIM_AMOUNT, APPROVED_AMOUNT, STATUS, METADATA$ACTION, METADATA$ISUPDATE)
         VALUES (S.CLAIM_ID, S.POLICY_ID, S.CUSTOMER_ID, S.PROVIDER_ID, S.REGION_ID, S.PRODUCT_TYPE, S.CLAIM_AMOUNT, S.APPROVED_AMOUNT, S.STATUS, S.METADATA$ACTION, S.METADATA$ISUPDATE);

-- INSERT NEW CLAIMS TO FACT CLAIMS --
CREATE OR REPLACE TASK TASK_2
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_1
AS 
MERGE INTO FACTCLAIMS F      
USING PSEUDO_STREAM S
ON F.CLAIM_ID = S.CLAIM_ID
WHEN MATCHED 
AND S.METADATA$ACTION ='INSERT'
AND S.METADATA$ISUPDATE = TRUE
THEN UPDATE SET
    POLICY_ID = S.POLICY_ID,
    CUSTOMER_ID = S.CUSTOMER_ID, 
    PROVIDER_ID = S.PROVIDER_ID, 
    REGION_ID = S.REGION_ID, 
    PRODUCT_TYPE = S.PRODUCT_TYPE, 
    CLAIM_AMOUNT = S.CLAIM_AMOUNT, 
    APPROVED_AMOUNT = S.APPROVED_AMOUNT, 
    STATUS = S.STATUS
WHEN NOT MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    THEN INSERT (CLAIM_ID, POLICY_ID, CUSTOMER_ID, PROVIDER_ID, REGION_ID, PRODUCT_TYPE, CLAIM_AMOUNT, APPROVED_AMOUNT, STATUS)
         VALUES (S.CLAIM_ID, S.POLICY_ID, S.CUSTOMER_ID, S.PROVIDER_ID, S.REGION_ID, S.PRODUCT_TYPE, S.CLAIM_AMOUNT, S.APPROVED_AMOUNT, S.STATUS);

 -- UPDATE LATEST SETTELMENT STATUS IN FACT SETTELMENTS --
CREATE OR REPLACE TASK TASK_3
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_2
AS
MERGE INTO FACTSETTLEMENTS F      
USING PSEUDO_STREAM S
ON F.CLAIM_ID = S.CLAIM_ID
WHEN MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    AND S.METADATA$ISUPDATE = TRUE
    THEN UPDATE SET
        F.SETTLEMENTAPPROVAL = S.APPROVAL_DATE IS NOT NULL, 
        F.TAT_DAYS = IFF(APPROVAL_DATE IS NOT NULL, DATEDIFF('day', S.FNOL_DATE, S.APPROVAL_DATE), NULL), 
        F.LEAKAGEINDICATOR = 
        CASE 
            WHEN S.APPROVED_AMOUNT > S.CLAIM_AMOUNT THEN S.APPROVED_AMOUNT - S.CLAIM_AMOUNT
            ELSE 0
        END
WHEN NOT MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    THEN INSERT (CLAIM_ID, SETTLEMENTAPPROVAL, TAT_DAYS, LEAKAGEINDICATOR)
         VALUES (S.CLAIM_ID, S.APPROVAL_DATE IS NOT NULL, IFF(APPROVAL_DATE IS NOT NULL, DATEDIFF('day', S.FNOL_DATE, S.APPROVAL_DATE), NULL), CASE WHEN S.APPROVED_AMOUNT > S.CLAIM_AMOUNT THEN S.APPROVED_AMOUNT - S.CLAIM_AMOUNT ELSE 0 END);

-- INSERT INTO DIMCUSTOMER --
CREATE OR REPLACE TASK TASK_4
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_3
AS
MERGE INTO DIMCUSTOMER D
USING (SELECT ST.CUSTOMER_ID, CUSTOMER_NAME, ST.REGION_ID, RISKBAND, PHONE, EMAIL FROM PSEUDO_STREAM ST
        JOIN RAW_DATA.CUSTOMER_PROFILE P ON P.CUSTOMER_ID = ST.CUSTOMER_ID) S
ON D.CUSTOMER_ID = S.CUSTOMER_ID
WHEN NOT MATCHED 
    THEN INSERT (CUSTOMER_ID, CUSTOMER_NAME, REGION_ID, RISKBAND, PHONE, EMAIL)
         VALUES (S.CUSTOMER_ID, S.CUSTOMER_NAME, S.REGION_ID, S.RISKBAND, S.PHONE, S.EMAIL);

-- INSERT INTO DIMPOLICY --
CREATE OR REPLACE TASK TASK_5
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_4
AS
MERGE INTO DIMPOLICY D
USING (SELECT ST.POLICY_ID, P.PRODUCT_TYPE, P.TENUREMONTHS, P.SUMASSURED FROM PSEUDO_STREAM ST
        JOIN RAW_DATA.POLICY_MASTER P ON P.POLICY_ID = ST.POLICY_ID) S
ON D.POLICY_ID = S.POLICY_ID
WHEN NOT MATCHED 
    THEN INSERT (POLICY_ID, PRODUCT_TYPE, TENUREMONTHS, SUMASSURED)
         VALUES (S.POLICY_ID, S.PRODUCT_TYPE, S.TENUREMONTHS, S.SUMASSURED);

 -- UPSERT INTO DIMDATES --
CREATE OR REPLACE TASK TASK_6
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_5
AS
MERGE INTO DIMDATES D    
USING (SELECT CT.POLICY_ID, FNOL_DATE, SURVEY_DATE, APPROVAL_DATE, PAYMENT_DATE, STARTDATE, ENDDATE, DETECTIONDATE, CT.METADATA$ACTION, CT.METADATA$ISUPDATE
        FROM PSEUDO_STREAM CT
        JOIN RAW_DATA.POLICY_MASTER PM ON CT.POLICY_ID = PM.POLICY_ID
        JOIN RAW_DATA.FRAUD_ALERTS FA ON CT.CLAIM_ID = FA.CLAIMID) S
ON D.POLICY_ID = S.POLICY_ID
WHEN MATCHED 
AND S.METADATA$ACTION ='INSERT'
AND S.METADATA$ISUPDATE = TRUE
    THEN UPDATE SET
        D.FNOL_DATE = S.FNOL_DATE, 
        D.SURVEY_DATE = S.SURVEY_DATE, 
        D.APPROVAL_DATE= S.APPROVAL_DATE, 
        D.PAYMENT_DATE = S.PAYMENT_DATE, 
        D.STARTDATE = S.STARTDATE, 
        D.ENDDATE = S.ENDDATE, 
        D.DETECTIONDATE = S.DETECTIONDATE
WHEN NOT MATCHED 
AND S.METADATA$ACTION ='INSERT'
THEN INSERT (POLICY_ID, FNOL_DATE, SURVEY_DATE, APPROVAL_DATE, PAYMENT_DATE, STARTDATE, ENDDATE, DETECTIONDATE)
     VALUES (S.POLICY_ID, S.FNOL_DATE, S.SURVEY_DATE, S.APPROVAL_DATE, S.PAYMENT_DATE, S.STARTDATE, S.ENDDATE, S.DETECTIONDATE);
     
-- TRUNCATING THE PSEUDO STREAM TABLE --
CREATE OR REPLACE TASK TASK_7
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_6
AS
TRUNCATE TABLE PSEUDO_STREAM;

-- TASK RESUME --
ALTER TASK TASK_7 RESUME;
ALTER TASK TASK_6 RESUME;
ALTER TASK TASK_5 RESUME;
ALTER TASK TASK_4 RESUME;
ALTER TASK TASK_3 RESUME;
ALTER TASK TASK_2 RESUME;
ALTER TASK TASK_1 RESUME;

SHOW TASKS;

-- SUSPEND TASK --
ALTER TASK TASK_1 SUSPEND;
ALTER TASK TASK_2 SUSPEND;
ALTER TASK TASK_3 SUSPEND;
ALTER TASK TASK_4 SUSPEND;
ALTER TASK TASK_5 SUSPEND;
ALTER TASK TASK_6 SUSPEND;
ALTER TASK TASK_7 SUSPEND;

-- AUDIT TABLE --
CREATE OR REPLACE TABLE AUDIT_LOGS 
(
    ALERTID INT, 
    CLAIMID INT,
    POLICYID INT,
    DETECTIONDATE DATE, 
    FRAUDTYPE STRING, 
    MODELSCORE NUMBER(10, 3), 
    INVESTIGATIONSTATUS STRING,
    OUTCOME STRING, 
    CHANGETYPE STRING, 
    IS_UPDATE STRING,
    CHANGE_AT TIMESTAMP
);

-- CREATING A PSEUDO STREAM --
CREATE OR REPLACE TABLE PSEUDO_STREAM_2 AS SELECT * FROM RAW_DATA.ST_FRAUD_ALERTS;

-- CREATING A TASK TO COPY INTO PSEUDO STREAM --
CREATE OR REPLACE TASK S2_TASK_1
WAREHOUSE = 'CAPSTONE_PROJECT'
SCHEDULE = '1 HOUR'
AS 
INSERT INTO PSEUDO_STREAM_2
SELECT * FROM RAW_DATA.ST_FRAUD_ALERTS;

-- INSERT NEW CLAIMS TO FACT CLAIMS --
CREATE OR REPLACE TASK S2_TASK_2
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER S2_TASK_1
AS 
MERGE INTO FACTFRAUD F      
USING PSEUDO_STREAM_2 S
ON F.ALERTID = S.ALERTID
WHEN MATCHED 
THEN UPDATE SET
    F.OUTCOME = S.OUTCOME,
    F.INVESTIGATIONSTATUS = S.INVESTIGATIONSTATUS
WHEN NOT MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    THEN INSERT (ALERTID, CLAIMID, SIU_Flag, MODELSCORE, INVESTIGATIONSTATUS, OUTCOME)
         VALUES (S.ALERTID, S.CLAIMID, (S.MODELSCORE > 0.5), S.MODELSCORE, S.INVESTIGATIONSTATUS, OUTCOME);

 -- UPDATE LOG TABLE --
CREATE OR REPLACE TASK S2_TASK_3
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER S2_TASK_2
AS
INSERT INTO AUDIT_LOGS (ALERTID, CLAIMID, POLICYID, DETECTIONDATE, FRAUDTYPE, MODELSCORE, INVESTIGATIONSTATUS, OUTCOME, CHANGETYPE, IS_UPDATE, CHANGE_AT) 
SELECT ALERTID, CLAIMID, POLICYID, DETECTIONDATE, FRAUDTYPE, MODELSCORE, INVESTIGATIONSTATUS, OUTCOME, METADATA$ACTION, METADATA$ISUPDATE, CURRENT_TIMESTAMP()
FROM PSEUDO_STREAM_2;

-- TRUNCATING THE PSEUDO STREAM TABLE --
CREATE OR REPLACE TASK S2_TASK_4
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER S2_TASK_3
AS
TRUNCATE TABLE PSEUDO_STREAM_2;

-- TASK RESUME --
ALTER TASK S2_TASK_4 RESUME;
ALTER TASK S2_TASK_3 RESUME;
ALTER TASK S2_TASK_2 RESUME;
ALTER TASK S2_TASK_1 RESUME;

-- SUSPEND TASK --
ALTER TASK S2_TASK_1 SUSPEND;
ALTER TASK S2_TASK_2 SUSPEND;
ALTER TASK S2_TASK_3 SUSPEND;
ALTER TASK S2_TASK_4 SUSPEND;

----------------------------------------------------------- TASK 10 -----------------------------------------------------------
-- MATERIALIZED VIEW 1 --
CREATE OR REPLACE TABLE FRAUD_RATE AS
SELECT DP.PRODUCT_TYPE, COUNTRY, (((SELECT COUNT(OUTCOME) FROM FACTFRAUD WHERE OUTCOME = 'Confirmed')/(SELECT COUNT(*) FROM FACTFRAUD)) * 100) AS RATE
FROM FACTCLAIMS FC
JOIN DIMPOLICY DP ON DP.POLICY_ID = FC.POLICY_ID
JOIN DIMREGION DR ON DR.REGION_ID = FC.REGION_ID
GROUP BY DP.PRODUCT_TYPE, COUNTRY;

CREATE MATERIALIZED VIEW MV_FRAUD_RISK_TRENDS
AS SELECT * FROM FRAUD_RATE;

-- MATERIALIZED VIEW 2 --
CREATE OR REPLACE TABLE PROVIDER_ANOMALIES AS
WITH provider_stats AS (
    SELECT
        f.PROVIDER_ID,
        dp.PROVIDER_NAME,
        dp.CATEGORY,
        dp.REGION_ID,
        COUNT(*)                           AS claims_count,
        SUM(f.APPROVED_AMOUNT)             AS sum_approved_amount,
        AVG(f.APPROVED_AMOUNT)             AS avg_approved_amount
    FROM FACTCLAIMS f
    JOIN DIMPROVIDER dp ON f.PROVIDER_ID = dp.PROVIDER_ID
    GROUP BY 1,2,3,4
),
peer_stats AS (
    SELECT
        CATEGORY,
        REGION_ID,
        SUM(sum_approved_amount) AS peer_total_approved,
        SUM(claims_count)        AS peer_total_claims
    FROM provider_stats
    GROUP BY 1,2
)
SELECT
    ps.PROVIDER_ID,
    ps.PROVIDER_NAME,
    ps.CATEGORY,
    ps.REGION_ID,
    ps.claims_count,
    ps.avg_approved_amount,
    CASE 
        WHEN (peer_total_claims - ps.claims_count) > 0 THEN
            (peer_total_approved - ps.sum_approved_amount)
            / NULLIF(peer_total_claims - ps.claims_count, 0)
        ELSE NULL
    END AS peer_avg_approved,
    CASE 
        WHEN (peer_total_claims - ps.claims_count) > 0 THEN
            ps.avg_approved_amount /
            (
              (peer_total_approved - ps.sum_approved_amount)
              / NULLIF(peer_total_claims - ps.claims_count, 0)
            )
        ELSE NULL
    END AS outlier_index
FROM provider_stats ps
JOIN peer_stats USING (CATEGORY, REGION_ID);

CREATE MATERIALIZED VIEW MV_PROVIDER_ANOMALIES
AS
SELECT * FROM PROVIDER_ANOMALIES;

-- MATERIALIZED VIEW 3 --
CREATE OR REPLACE TABLE AVG_DATA AS
SELECT DR.BRANCH, AVG(DATEDIFF(day, D.FNOL_DATE, D.PAYMENT_DATE)) AS AVG_SETTELMENT_DAYS, AVG(FS.LEAKAGEINDICATOR) AS AVG_LEKAGE
FROM FACTCLAIMS FC 
JOIN DIMDATES D ON D.POLICY_ID = FC.POLICY_ID
JOIN DIMREGION DR ON DR.REGION_ID = FC.REGION_ID
JOIN FACTSETTLEMENTS FS ON FS.CLAIM_ID = FC.CLAIM_ID
GROUP BY DR.BRANCH;

CREATE MATERIALIZED VIEW MV_SETTLEMENT_TAT 
AS
SELECT * FROM AVG_DATA;