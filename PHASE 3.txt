----------------------------------------------------------- TASK 8 -----------------------------------------------------------
-- STREAMS --
CREATE OR REPLACE STREAM ST_CLAIM_TRANSACTION ON TABLE RAW_DATA.STG_CLAIM_TRANSACTION;
CREATE OR REPLACE STREAM ST_FRAUD_ALERTS ON TABLE RAW_DATA.FRAUD_ALERTS;

SELECT * FROM RAW_DATA.ST_CLAIM_TRANSACTION;
SELECT * FROM RAW_DATA.ST_FRAUD_ALERTS;
----------------------------------------------------------- TASK 9 -----------------------------------------------------------
-- CREATING A PSEUDO STREAM --
CREATE OR REPLACE TABLE PSEUDO_STREAM AS SELECT * FROM RAW_DATA.ST_CLAIM_TRANSACTION;

-- CREATING A TASK TO COPY INTO MANNUAL STREAM --
CREATE OR REPLACE TASK TASK_1
WAREHOUSE = 'CAPSTONE_PROJECT'
SCHEDULE = '1 HOUR'
AS 
INSERT INTO PSEUDO_STREAM 
SELECT * FROM RAW_DATA.ST_CLAIM_TRANSACTION;

-- INSERT NEW CLAIMS TO FACT CLAIMS --
CREATE OR REPLACE TASK TASK_2
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_1
AS 
MERGE INTO FACTCLAIMS F      
USING PSEUDO_STREAM S
ON F.CLAIM_ID = S.CLAIM_ID
WHEN MATCHED 
AND S.METADATA$ACTION ='INSERT'
AND S.METADATA$ISUPDATE = TRUE
THEN UPDATE SET
    POLICY_ID = S.POLICY_ID,
    CUSTOMER_ID = S.CUSTOMER_ID, 
    PROVIDER_ID = S.PROVIDER_ID, 
    REGION_ID = S.REGION_ID, 
    PRODUCT_TYPE = S.PRODUCT_TYPE, 
    CLAIM_AMOUNT = S.CLAIM_AMOUNT, 
    APPROVED_AMOUNT = S.APPROVED_AMOUNT, 
    STATUS = S.STATUS
WHEN NOT MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    THEN INSERT (CLAIM_ID, POLICY_ID, CUSTOMER_ID, PROVIDER_ID, REGION_ID, PRODUCT_TYPE, CLAIM_AMOUNT, APPROVED_AMOUNT, STATUS)
         VALUES (S.CLAIM_ID, S.POLICY_ID, S.CUSTOMER_ID, S.PROVIDER_ID, S.REGION_ID, S.PRODUCT_TYPE, S.CLAIM_AMOUNT, S.APPROVED_AMOUNT, S.STATUS);

 -- UPDATE LATEST SETTELMENT STATUS IN FACT SETTELMENTS --
CREATE OR REPLACE TASK TASK_3
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_2
AS
MERGE INTO FACTSETTLEMENTS F      
USING PSEUDO_STREAM S
ON F.CLAIM_ID = S.CLAIM_ID
WHEN MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    AND S.METADATA$ISUPDATE = TRUE
    THEN UPDATE SET
        F.SETTLEMENTAPPROVAL = S.APPROVAL_DATE IS NOT NULL, 
        F.TAT_DAYS = IFF(APPROVAL_DATE IS NOT NULL, DATEDIFF('day', S.FNOL_DATE, S.APPROVAL_DATE), NULL), 
        F.LEAKAGEINDICATOR = 
        CASE 
            WHEN S.APPROVED_AMOUNT > S.CLAIM_AMOUNT THEN S.APPROVED_AMOUNT - S.CLAIM_AMOUNT
            ELSE 0
        END;
         
-- TRUNCATING THE PSEUDO STREAM TABLE --
CREATE OR REPLACE TASK TASK_4
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER TASK_3
AS
TRUNCATE TABLE PSEUDO_STREAM;

-- TASK RESUME --
ALTER TASK TASK_4 RESUME;
ALTER TASK TASK_3 RESUME;
ALTER TASK TASK_2 RESUME;
ALTER TASK TASK_1 RESUME;

-- SUSPEND TASK --
ALTER TASK TASK_1 SUSPEND;
ALTER TASK TASK_2 SUSPEND;
ALTER TASK TASK_3 SUSPEND;
ALTER TASK TASK_4 SUSPEND;

-- AUDIT TABLE --
CREATE OR REPLACE TABLE AUDIT_LOGS 
(
    ALERTID INT, 
    CLAIMID INT,
    POLICYID INT,
    DETECTIONDATE DATE, 
    FRAUDTYPE STRING, 
    MODELSCORE NUMBER(10, 3), 
    INVESTIGATIONSTATUS STRING,
    OUTCOME STRING, 
    CHANGETYPE STRING, 
    IS_UPDATE STRING,
    CHANGE_AT TIMESTAMP
);

-- CREATING A PSEUDO STREAM --
CREATE OR REPLACE TABLE PSEUDO_STREAM_2 AS SELECT * FROM RAW_DATA.ST_FRAUD_ALERTS;

-- CREATING A TASK TO COPY INTO PSEUDO STREAM --
CREATE OR REPLACE TASK S2_TASK_1
WAREHOUSE = 'CAPSTONE_PROJECT'
SCHEDULE = '1 HOUR'
AS 
INSERT INTO PSEUDO_STREAM_2
SELECT * FROM RAW_DATA.ST_FRAUD_ALERTS;

-- INSERT NEW CLAIMS TO FACT CLAIMS --
CREATE OR REPLACE TASK S2_TASK_2
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER S2_TASK_1
AS 
MERGE INTO FACTFRAUD F      
USING PSEUDO_STREAM_2 S
ON F.ALERTID = S.ALERTID
WHEN MATCHED 
THEN UPDATE SET
    F.OUTCOME = S.OUTCOME,
    F.INVESTIGATIONSTATUS = S.INVESTIGATIONSTATUS
WHEN NOT MATCHED 
    AND S.METADATA$ACTION ='INSERT'
    THEN INSERT (ALERTID, CLAIMID, SIU_Flag, MODELSCORE, INVESTIGATIONSTATUS, OUTCOME)
         VALUES (S.ALERTID, S.CLAIMID, (S.MODELSCORE > 0.5), S.MODELSCORE, S.INVESTIGATIONSTATUS, OUTCOME);

 -- UPDATE LATEST SETTELMENT STATUS IN FACT SETTELMENTS --
CREATE OR REPLACE TASK S2_TASK_3
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER S2_TASK_2
AS
INSERT INTO AUDIT_LOGS (ALERTID, CLAIMID, POLICYID, DETECTIONDATE, FRAUDTYPE, MODELSCORE, INVESTIGATIONSTATUS, OUTCOME, CHANGETYPE, IS_UPDATE, CHANGE_AT) 
SELECT ALERTID, CLAIMID, POLICYID, DETECTIONDATE, FRAUDTYPE, MODELSCORE, INVESTIGATIONSTATUS, OUTCOME, METADATA$ACTION, METADATA$ISUPDATE, CURRENT_TIMESTAMP()
FROM PSEUDO_STREAM_2;

-- TRUNCATING THE PSEUDO STREAM TABLE --
CREATE OR REPLACE TASK S2_TASK_4
WAREHOUSE = 'CAPSTONE_PROJECT'
AFTER S2_TASK_3
AS
TRUNCATE TABLE PSEUDO_STREAM_2;

-- TASK RESUME --
ALTER TASK S2_TASK_4 RESUME;
ALTER TASK S2_TASK_3 RESUME;
ALTER TASK S2_TASK_2 RESUME;
ALTER TASK S2_TASK_1 RESUME;

-- SUSPEND TASK --
ALTER TASK S2_TASK_1 SUSPEND;
ALTER TASK S2_TASK_2 SUSPEND;
ALTER TASK S2_TASK_3 SUSPEND;
ALTER TASK S2_TASK_4 SUSPEND;

----------------------------------------------------------- TASK 10 -----------------------------------------------------------
-- MATERIALIZED VIEW 1 --
CREATE OR REPLACE TABLE FRAUD_RATE AS
SELECT DP.PRODUCT_TYPE, COUNTRY, (((SELECT COUNT(OUTCOME) FROM FACTFRAUD WHERE OUTCOME = 'Confirmed')/(SELECT COUNT(*) FROM FACTFRAUD)) * 100) AS RATE
FROM FACTCLAIMS FC
JOIN DIMPOLICY DP ON DP.POLICY_ID = FC.POLICY_ID
JOIN DIMREGION DR ON DR.REGION_ID = FC.REGION_ID
GROUP BY DP.PRODUCT_TYPE, COUNTRY;

CREATE MATERIALIZED VIEW MV_FRAUD_RISK_TRENDS
AS SELECT * FROM FRAUD_RATE;

-- MATERIALIZED VIEW 2 --


-- MATERIALIZED VIEW 3 --
CREATE OR REPLACE TABLE AVG_DATA AS
SELECT DR.BRANCH, AVG(DATEDIFF(day, D.FNOL_DATE, D.PAYMENT_DATE)) AS AVG_SETTELMENT_DAYS, AVG(FS.LEAKAGEINDICATOR) AS AVG_LEKAGE
FROM FACTCLAIMS FC 
JOIN DIMDATES D ON D.POLICY_ID = FC.POLICY_ID
JOIN DIMREGION DR ON DR.REGION_ID = FC.REGION_ID
JOIN FACTSETTLEMENTS FS ON FS.CLAIM_ID = FC.CLAIM_ID
GROUP BY DR.BRANCH;

CREATE MATERIALIZED VIEW MV_SETTLEMENT_TAT 
AS
SELECT * FROM AVG_DATA;