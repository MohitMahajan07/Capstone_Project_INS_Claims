----------------------------------------------------------- TASK 11 -----------------------------------------------------------
-- MAKING ROLES --
CREATE OR REPLACE ROLE MANAGER;
CREATE OR REPLACE ROLE METRO;
CREATE OR REPLACE ROLE URBAN;
CREATE OR REPLACE ROLE SUB_URBAN;
CREATE OR REPLACE ROLE RURAL;

-- PERMISSIONS --
GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO ROLE MANAGER;
GRANT USAGE ON DATABASE PROJECT_DATA TO ROLE MANAGER;
GRANT USAGE ON SCHEMA STAR_DATA TO ROLE MANAGER;

GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO ROLE ACC_ADMIN;
GRANT USAGE ON DATABASE PROJECT_DATA TO ROLE ACC_ADMIN;
GRANT USAGE ON SCHEMA STAR_DATA TO ROLE ACC_ADMIN;

GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO ROLE METRO;
GRANT USAGE ON DATABASE PROJECT_DATA TO ROLE METRO;
GRANT USAGE ON SCHEMA STAR_DATA TO ROLE METRO;

GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO ROLE URBAN;
GRANT USAGE ON DATABASE PROJECT_DATA TO ROLE URBAN;
GRANT USAGE ON SCHEMA STAR_DATA TO ROLE URBAN;

GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO ROLE SUB_URBAN;
GRANT USAGE ON DATABASE PROJECT_DATA TO ROLE SUB_URBAN;
GRANT USAGE ON SCHEMA STAR_DATA TO ROLE SUB_URBAN;

GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO ROLE RURAL;
GRANT USAGE ON DATABASE PROJECT_DATA TO ROLE RURAL;
GRANT USAGE ON SCHEMA STAR_DATA TO ROLE RURAL;

show users;
-- MAKING USERS --
CREATE OR REPLACE USER MANAGER
PASSWORD = 'MANAGER@123'
DEFAULT_ROLE = MANAGER
MUST_CHANGE_PASSWORD = FALSE;

CREATE OR REPLACE USER METRO_USER
PASSWORD = 'METRO@123'
DEFAULT_ROLE = METRO
MUST_CHANGE_PASSWORD = FALSE;

CREATE OR REPLACE USER URBAN_USER
PASSWORD = 'URBAN@123'
DEFAULT_ROLE = URBAN
MUST_CHANGE_PASSWORD = FALSE;

CREATE OR REPLACE USER SUB_URBAN_USER
PASSWORD = 'SUBURBAN@123'
DEFAULT_ROLE = SUB_URBAN
MUST_CHANGE_PASSWORD = FALSE;

CREATE OR REPLACE USER RURAL_USER
PASSWORD = 'RURAL@123'
DEFAULT_ROLE = RURAL
MUST_CHANGE_PASSWORD = FALSE;

-- GRANT ROLE TO USER --
GRANT ROLE MANAGER TO USER MANAGER;
GRANT ROLE METRO TO USER METRO_USER;
GRANT ROLE URBAN TO USER URBAN_USER;
GRANT ROLE SUB_URBAN TO USER SUB_URBAN_USER;
GRANT ROLE RURAL TO USER RURAL_USER;

-- ROW ACCESS POLICY --
CREATE OR REPLACE ROW ACCESS POLICY USER_POLICY_2
AS (REGION_ID INT) RETURNS BOOLEAN ->
    IS_ROLE_IN_SESSION('MANAGER') OR
    IS_ROLE_IN_SESSION('ACCOUNTADMIN')
    OR EXISTS (
        SELECT 1
        FROM DIMREGION rh
        WHERE rh.REGION_ID = REGION_ID
          AND (
               (IS_ROLE_IN_SESSION('METRO') AND rh.ZONE = 'Metro')
            OR (IS_ROLE_IN_SESSION('URBAN') AND rh.ZONE = 'Urban')
            OR (IS_ROLE_IN_SESSION('SUB_URBAN') AND rh.ZONE = 'Suburban')
            OR (IS_ROLE_IN_SESSION('RURAL') AND rh.ZONE = 'Rural')
          )
    );

-- APPLY POLICY TO TABLE --
ALTER TABLE FACTCLAIMS ADD ROW ACCESS POLICY USER_POLICY_2 ON (REGION_ID);

-- GRANT TABLE TO ROLES --
GRANT SELECT ON TABLE STAR_DATA.FACTCLAIMS TO ROLE METRO;
GRANT SELECT ON TABLE STAR_DATA.FACTCLAIMS TO ROLE URBAN;
GRANT SELECT ON TABLE STAR_DATA.FACTCLAIMS TO ROLE SUB_URBAN;
GRANT SELECT ON TABLE STAR_DATA.FACTCLAIMS TO ROLE RURAL;

-- MASKING POLICY --
-- EMAIL
CREATE OR REPLACE MASKING POLICY MASK_EMAIL
AS (EMAIL STRING) RETURNS STRING ->
    CASE
        WHEN CURRENT_ROLE() IN ('MANAGER', 'ACCOUNTADMIN') THEN EMAIL
        ELSE 'USER@XXXXXXXXXXXX'
    END;

-- PHONE
CREATE OR REPLACE MASKING POLICY MASK_PHONE
AS (PHONE STRING) RETURNS STRING ->
    CASE
        WHEN CURRENT_ROLE() IN ('MANAGER', 'ACCOUNTADMIN') THEN PHONE
        ELSE 'XXXXX-XXXXX'
    END;

-- APPLYING POLICY --
ALTER TABLE DIMCUSTOMER MODIFY COLUMN EMAIL SET MASKING POLICY MASK_EMAIL;
ALTER TABLE DIMCUSTOMER MODIFY COLUMN PHONE SET MASKING POLICY MASK_PHONE;

-- GRANT PERMISSION TO TABLES --
GRANT SELECT ON TABLE STAR_DATA.DIMCUSTOMER TO ROLE MANAGER;
GRANT SELECT ON TABLE STAR_DATA.DIMCUSTOMER TO ROLE METRO;
GRANT SELECT ON TABLE STAR_DATA.DIMCUSTOMER TO ROLE URBAN;
GRANT SELECT ON TABLE STAR_DATA.DIMCUSTOMER TO ROLE SUB_URBAN;
GRANT SELECT ON TABLE STAR_DATA.DIMCUSTOMER TO ROLE RURAL;

----------------------------------------------------------- TASK 12 -----------------------------------------------------------
-- CREATE SHARE --
CREATE OR REPLACE SHARE CP_SHARE;

GRANT USAGE ON WAREHOUSE CAPSTONE_PROJECT TO SHARE CP_SHARE;
GRANT USAGE ON DATABASE PROJECT_DATA TO SHARE CP_SHARE;
GRANT USAGE ON SCHEMA STAR_DATA TO SHARE CP_SHARE;

ALTER MATERIALIZED VIEW MV_FRAUD_RISK_TRENDS SET SECURE;
ALTER MATERIALIZED VIEW MV_SETTLEMENT_TAT SET SECURE;

GRANT SELECT ON STAR_DATA.MV_FRAUD_RISK_TRENDS TO SHARE CP_SHARE;
GRANT SELECT ON STAR_DATA.MV_SETTLEMENT_TAT TO SHARE CP_SHARE;

-- READER ACCOUNT --
CREATE MANAGED ACCOUNT MOHIT_READER
ADMIN_NAME = 'READER_USER'
ADMIN_PASSWORD = 'Reader@123456789'
TYPE = READER;

SHOW MANAGED ACCOUNTS;

ALTER SHARE CP_SHARE ADD ACCOUNT = WA69974;